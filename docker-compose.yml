# Spins up mock production environment
version: '3'
services:
  # Reverse proxy/load balancer
  nginx:
    build: ./nginx
    depends_on:
      - rtcServer
      - sessionServer
    ports:
      - '5000:80'

  # mediasoup voice server
  rtcServer:
    build:
      context: ./rtc-server
      dockerfile: Dockerfile
    image: insync-rtc-service
    volumes:
      - /rtc-server/node_modules
    expose:
      - '4000'

  # socketio session server
  sessionServer:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: insync-session-service
    volumes:
      - /server/node_modules
    expose:
      - '5000'
    depends_on:
      - redisSocketIoAdapter
      - redisRoomState
      - redisClientRoomId
      - redisWaitingRoomId

  # spin up 4 redis containers, 1 for socket.io adapter, 3 for holding room state
  redisSocketIoAdapter:
    image: redis:alpine
    expose:
      - '6379'
  redisRoomState:
    image: redis:alpine
    command: --port 6380
    expose:
      - '6380'
  redisClientRoomId:
    image: redis:alpine
    command: --port 6381
    expose:
      - '6381'
  redisWaitingRoomId:
    image: redis:alpine
    command: --port 6382
    expose:
      - '6382'
